<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<title>CoinCraft — Save Smart</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
  :root {
    --navy: #001f3f;
    --darkblue: #002b5c;
    --lightblue: #0074D9;
    --mutedblue: #b0c4de;
    --glass: rgba(255, 255, 255, 0.03);
    --white: #fff;
	
    --coin1: #ffd76b;  /* R1 */
    --coin2: #9bd2ff; /* R2 */
    --coin5: #ff9bd2; /* R5 */
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; 
    font-family: Inter, ui-sans-serif, system-ui, sans-serif;
    background: linear-gradient(180deg, var(--navy) 0%, var(--darkblue) 100%);
    color: var(--white);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    position: sticky; top: 0;
    background: rgba(0, 31, 63, 0.9);
    backdrop-filter: blur(8px);
    padding: 16px 22px;
    display: flex; align-items: center; gap: 16px;
    border-bottom: 1px solid rgba(255 255 255 / 0.05);
    z-index: 20;
  }
  .logo { cursor: pointer; display: flex; align-items: center; gap: 12px; user-select: none; }
  .logo .mark {
    background: linear-gradient(#3a8f3a, #2e6d2e); /* Grass-like gradient */
    color: #fff176; /* Gold/yellow letters like coins */
    font-family: 'Press Start 2P', cursive;
    font-weight: 700;
    font-size: 14px;
    width: 44px;
    height: 44px;
    border-radius: 4px;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: inset 0 -4px #1e4d1e, inset 0 4px #4caf50;
    border: 2px solid #1e4d1e;
}

  .logo .text { display: flex; flex-direction: column; line-height: 1; }
  .logo .text .title {
    font-family: 'Press Start 2P', cursive;
    font-size: 14px;
    color: #fff176;
}

  .logo .text .subtitle { font-size: 12px; color: var(--mutedblue); }
  nav { margin-left: auto; display: flex; gap: 8px; }
  button.nav-btn {
    background: transparent; border: none; color: var(--mutedblue);
    padding: 8px 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease;
  }
  button.nav-btn.active, button.nav-btn:hover { background: var(--lightblue); color: var(--white); }

  main.container {
    max-width: 1000px; margin: 22px auto 44px; width: 90vw;
    display: grid; gap: 22px; flex-grow: 1;
  }
  section.view { display: none; }
  section.view.active { display: block; }

  /* Cards */
  .card {
    background: var(--darkblue); padding: 18px 20px; border-radius: 12px;
    box-shadow: 0 0 20px rgba(0 0 0 / 0.3);
  }
  h1, h2, h3, h4 { margin-top: 0; }
  p, ul { line-height: 1.5; }
  ul { padding-left: 20px; }

  /* About card on home */
  #about-home { margin-top: 18px; }

  /* Star Badge */
  #star-badge {
    background: var(--lightblue); color: var(--white); padding: 14px 18px; border-radius: 14px;
    font-weight: 700; font-size: 18px; width: fit-content; user-select: none;
    display: flex; align-items: center; gap: 10px; box-shadow: 0 0 10px var(--lightblue);
  }

  /* Inputs & Labels */
  label { display: block; margin-bottom: 6px; color: var(--mutedblue); font-size: 13px; }
  input[type="number"], input[type="text"], textarea, select {
    width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255 255 255 / 0.1);
    background: var(--glass); color: var(--white); font-size: 15px; outline: none;
  }
  input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

  /* Buttons */
  button.primary {
    background: var(--lightblue); border: none; color: var(--white);
    padding: 12px 18px; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 12px; transition: background-color 0.3s ease;
  }
  button.primary:hover { background: #005bb5; }
  button.small { padding: 6px 10px; font-size: 14px; border-radius: 8px; }

  /* Tables */
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; word-break: break-word; }
  th, td { padding: 8px 10px; border-bottom: 1px solid rgba(255 255 255 / 0.05); text-align: left; }
  th { background: rgba(255 255 255 / 0.05); }
  input.table-input {
    width: 100%; background: transparent; border: none; color: var(--white); font-size: 14px; padding: 4px 6px; border-radius: 6px; outline: none;
  }
  input.table-input:focus { background: rgba(255 255 255 / 0.1); }

  /* SNAKE GAME */
  .game-wrap { display: grid; gap: 14px; }
  .game-top { display: grid; gap: 10px; }
  .hud { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .pill {
    background: rgba(255 255 255 / 0.08); border: 1px solid rgba(255 255 255 / 0.12);
    padding: 8px 12px; border-radius: 999px; font-weight: 700;
  }
  .legend { display: flex; gap: 8px; align-items: center; }
  .legend i { display: inline-block; width: 14px; height: 14px; border-radius: 4px; margin-right: 6px; }
  .board {
    display: grid; place-items: center;
    background: radial-gradient(120% 120% at 50% 0%, rgba(255 255 255 / .06), rgba(0 0 0 / .2)), rgba(0,0,0,.15);
    border: 1px solid rgba(255 255 255 / 0.1);
    border-radius: 12px; padding: 10px;
  }
  canvas { width: 100%; max-width: 520px; aspect-ratio: 1 / 1; background: rgba(0,0,0,.15); border-radius: 10px; }
  .controls { display: grid; grid-template-columns: repeat(3, 64px); justify-content: center; gap: 8px; margin: 6px auto 0; }
  .controls button {
    background: rgba(255 255 255 / 0.08);
    border: 1px solid rgba(255 255 255 / 0.12);
    color: var(--white); font-weight: 800; font-size: 18px;
    border-radius: 12px; padding: 10px;
  }
  .controls .spacer { visibility: hidden; }
  .game-actions { display: flex; gap: 8px; flex-wrap: wrap; }
  .note { color: var(--mutedblue); font-size: 13px; }

  /* Responsive */
  @media (max-width: 700px) {
    main.container { width: 95vw; }
    table, th, td { font-size: 13px; }
    button.nav-btn { padding: 6px 8px; font-size: 14px; }
  }
</style>
</head>
<body>
<header>
  <div class="logo" onclick="navigate('home')">
  <div class="mark pixel">CC</div>

    <div class="text">
      <div class="title">CoinCraft</div>
      <div class="subtitle">Save smarter. Start now.</div>
    </div>
  </div>
  <nav>
    <button class="nav-btn active" data-route="home" onclick="navigate('home')">Home</button>
    <button class="nav-btn" data-route="tools" onclick="navigate('tools')">Tools</button>
    <button class="nav-btn" data-route="game" onclick="navigate('game')">Game</button>
    <button class="nav-btn" data-route="about" onclick="navigate('about')">About</button>
  </nav>
</header>

<main class="container">
  <!-- Home -->
  <section id="view-home" class="view active">
    <div class="card">
      <h1>Win at saving — simple habits, real results</h1>
      <p>A modern toolkit for young earners: tax estimator, budget builder, and a fun coin-snake game to build your money skills.</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="primary" onclick="navigate('tools')">Open Tools</button>
        <button class="primary" onclick="navigate('game')">Play Game</button>
      </div>
    </div>
    <div id="star-badge" class="card" style="margin-top:20px;">
      <span id="star-emoji">⭐</span>
      <span id="star-count">0</span> stars — <span id="star-rank">Beginner Saver</span>
    </div>
    <div id="about-home" class="card">
      <h2>About CoinCraft</h2>
      <p>CoinCraft is your friendly sidekick for mastering your money. Whether you want to estimate your taxes, build a budget that works, or get quick tips, MoneyMate’s got you covered.</p>
      <p>Track your savings, earn stars, and level up your financial game with our easy-to-use tools designed for South African earners.</p>
    </div>
  </section>

  <!-- Tools -->
  <section id="view-tools" class="view">
    <div class="card">
      <h2>South African Tax Estimator</h2>
      <p>Enter your annual income to estimate your tax and take-home pay.</p>
      <label for="tax-income">Annual Income (ZAR):</label>
      <input type="number" min="0" id="tax-income" placeholder="e.g., 300000" />
      <button class="primary" onclick="calculateTax()">Calculate Tax</button>
      <table id="tax-result" style="margin-top: 12px; display:none;">
        <thead>
          <tr>
            <th>Tax Bracket</th>
            <th>Rate</th>
            <th>Tax Payable (ZAR)</th>
          </tr>
        </thead>
        <tbody id="tax-result-body"></tbody>
        <tfoot>
          <tr style="font-weight:700;">
            <td colspan="2">Total Tax</td>
            <td id="tax-total"></td>
          </tr>
          <tr style="font-weight:700; color: var(--lightblue);">
            <td colspan="2">Estimated Take Home</td>
            <td id="tax-takehome"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="card" style="margin-top: 28px;">
      <h2>Budget Builder</h2>
      <p>Add your income and expenses. Save more, earn stars!</p>
      <table id="budget-table">
        <thead>
          <tr>
            <th>Description</th>
            <th>Amount (ZAR)</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="budget-items"></tbody>
        <tfoot>
          <tr>
            <td><input type="text" id="new-desc" placeholder="E.g. Salary" /></td>
            <td><input type="number" id="new-amount" placeholder="E.g. 15000" min="0" /></td>
            <td>
              <select id="new-type">
                <option value="income" selected>Income</option>
                <option value="expense">Expense</option>
              </select>
            </td>
            <td><button class="primary small" onclick="addBudgetItem()">Add</button></td>
          </tr>
        </tfoot>
      </table>
      <div id="budget-summary" style="margin-top: 20px; font-weight: 700;">
        <p>Total Income: ZAR <span id="total-income">0</span></p>
        <p>Total Expenses: ZAR <span id="total-expenses">0</span></p>
        <p>Savings: ZAR <span id="total-savings">0</span> (<span id="savings-percent">0</span>%)</p>
      </div>
      <div id="star-msg" style="margin-top: 12px; font-size: 16px; font-weight: 700;"></div>
    </div>
  </section>
  
  <!-- Bond Calculator Section -->
<div id="bondCalculator" style="margin-top:20px;">
  <h2>Bond Calculator</h2>
  <label for="loanAmount">Loan Amount (ZAR):</label>
  <input type="number" id="loanAmount" value="500000">

  <label for="interestRate">Annual Interest Rate (%):</label>
  <input type="number" id="interestRate" value="10">

  <label for="termYears">Term (Years):</label>
  <input type="number" id="termYears" value="20">

  <button id="calcBondBtn">Calculate</button>

  <div id="bondResult" style="margin-top:10px; font-weight:bold;"></div>
</div>

<script>
  document.getElementById('calcBondBtn').addEventListener('click', function() {
    const principal = parseFloat(document.getElementById('loanAmount').value) || 0;
    const annualRate = (parseFloat(document.getElementById('interestRate').value) || 0) / 100;
    const years = parseInt(document.getElementById('termYears').value) || 0;

    const months = years * 12;
    const monthlyRate = annualRate / 12;

    const monthlyRepayment = (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months));
    const totalPaid = monthlyRepayment * months;
    const totalInterest = totalPaid - principal;

    document.getElementById('bondResult').innerHTML =
      `Monthly Repayment: R${monthlyRepayment.toFixed(2)}<br>` +
      `Total Paid: R${totalPaid.toFixed(2)}<br>` +
      `Total Interest: R${totalInterest.toFixed(2)}`;
  });
</script>

  <!-- GAME (replaces Chatbot) -->
  <section id="view-game" class="view">
    <div class="card game-wrap">
      <div class="game-top">
        <h2>Coin Snake — Eat coins, grow your savings!</h2>
        <div class="hud">
          <span class="pill">Score: R <span id="score">0</span></span>
          <span class="pill">Length: <span id="length">0</span></span>
          <span class="pill">High Score: R <span id="highscore">0</span></span>
          <span class="legend">
            <span class="pill" style="display:flex;align-items:center;gap:10px;">
              <span><i style="background:var(--coin1)"></i>R1</span>
              <span><i style="background:var(--coin2)"></i>R2</span>
              <span><i style="background:var(--coin5)"></i>R5</span>
            </span>
          </span>
        </div>
        <div class="game-actions">
          <button class="primary small" id="startBtn">Start / Pause</button>
          <button class="primary small" id="resetBtn">Reset</button>
          <span class="note">Use arrow keys (or WASD). On mobile, use the D-pad.</span>
        </div>
      </div>
      <div class="board">
        <canvas id="board" width="520" height="520" aria-label="Snake game board"></canvas>
      </div>
      <!-- Mobile controls -->
      <div class="controls" aria-hidden="false">
        <span class="spacer"></span>
        <button id="btnUp">▲</button>
        <span class="spacer"></span>
        <button id="btnLeft">◀</button>
        <button id="btnDown">▼</button>
        <button id="btnRight">▶</button>
      </div>
    </div>
  </section>

  <!-- About -->
  <section id="view-about" class="view">
    <div class="card">
      <h2>About CoinCraft</h2>
      <p>CoinCraft is your friendly sidekick for mastering your money. Whether you want to estimate your taxes, build a budget that works, or play a quick game to sharpen your coin sense—MoneyMate’s got you.</p>
      <p>Track your savings, earn stars, and level up your financial game with our easy-to-use tools designed for South African earners.</p>
      <p>Created with ❤️ for young earners wanting to take control of their finances.</p>
    </div>
  </section>
</main>



<script>
  // Navigation logic
  const views = document.querySelectorAll('section.view');
  const navButtons = document.querySelectorAll('button.nav-btn');
  function navigate(route) {
    views.forEach(v => v.classList.remove('active'));
    navButtons.forEach(b => b.classList.remove('active'));
    document.getElementById('view-' + route).classList.add('active');
    document.querySelector(`button.nav-btn[data-route=${route}]`).classList.add('active');
  }

  // ===== TAX ESTIMATOR LOGIC =====
  const taxBands = [
    { min: 0, max: 226000, rate: 0.18 },
    { min: 226001, max: 353100, rate: 0.26 },
    { min: 353101, max: 488700, rate: 0.31 },
    { min: 488701, max: 641400, rate: 0.36 },
    { min: 641401, max: 817600, rate: 0.39 },
    { min: 817601, max: 1731600, rate: 0.41 },
    { min: 1731601, max: Infinity, rate: 0.45 },
  ];
  function calculateTax() {
    const income = parseFloat(document.getElementById('tax-income').value);
    if (isNaN(income) || income < 0) { alert('Please enter a valid positive income'); return; }
    let totalTax = 0;
    const tbody = document.getElementById('tax-result-body');
    tbody.innerHTML = '';
    taxBands.forEach(band => {
      if (income > band.min) {
        const taxableAmount = Math.min(income, band.max) - band.min;
        const taxPayable = taxableAmount * band.rate;
        totalTax += taxPayable;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${band.min.toLocaleString()} - ${band.max === Infinity ? '∞' : band.max.toLocaleString()}</td>
          <td>${(band.rate * 100).toFixed(0)}%</td>
          <td>R ${taxPayable.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      }
    });
    document.getElementById('tax-total').textContent = 'R ' + totalTax.toFixed(2);
    document.getElementById('tax-takehome').textContent = 'R ' + (income - totalTax).toFixed(2);
    document.getElementById('tax-result').style.display = 'table';
  }

  // ===== BUDGET BUILDER LOGIC =====
  let budgetItems = JSON.parse(localStorage.getItem('CoinCraftBudgetItems')) || [];
  let starCount = parseInt(localStorage.getItem('moneyMateStars')) || 0;
  function saveBudget() { localStorage.setItem('moneyMateBudgetItems', JSON.stringify(budgetItems)); }
  function saveStars() { localStorage.setItem('moneyMateStars', starCount); updateStarBadge(); }
  function updateStarBadge() {
    const starCountEl = document.getElementById('star-count');
    const starRankEl = document.getElementById('star-rank');
    const starEmojiEl = document.getElementById('star-emoji');
    starCountEl.textContent = starCount;
    let rank = '', emoji = '';
    if (starCount >= 20) { rank = '🏆 Money Legend'; emoji = '🏆'; }
    else if (starCount >= 10) { rank = '💎 Master Saver'; emoji = '💎'; }
    else if (starCount >= 5) { rank = '💰 Smart Saver'; emoji = '💰'; }
    else { rank = '💼 Beginner Saver'; emoji = '⭐'; }
    starRankEl.textContent = rank; starEmojiEl.textContent = emoji;
  }
  function renderBudget() {
    const tbody = document.getElementById('budget-items'); tbody.innerHTML = '';
    budgetItems.forEach((item, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="table-input" value="${item.description}" onchange="updateBudgetItem(${index}, 'description', this.value)" /></td>
        <td><input type="number" min="0" class="table-input" value="${item.amount}" onchange="updateBudgetItem(${index}, 'amount', this.value)" /></td>
        <td>
          <select onchange="updateBudgetItem(${index}, 'type', this.value)">
            <option value="income" ${item.type === 'income' ? 'selected' : ''}>Income</option>
            <option value="expense" ${item.type === 'expense' ? 'selected' : ''}>Expense</option>
          </select>
        </td>
        <td><button class="primary small" onclick="removeBudgetItem(${index})">Remove</button></td>
      `;
      tbody.appendChild(tr);
    });
    updateBudgetSummary();
  }
  function updateBudgetItem(index, field, value) {
    if(field === 'amount') { value = parseFloat(value); if(isNaN(value) || value < 0) value = 0; }
    budgetItems[index][field] = value; saveBudget(); updateBudgetSummary();
  }
  function removeBudgetItem(index) { budgetItems.splice(index, 1); saveBudget(); renderBudget(); }
  function addBudgetItem() {
    const descInput = document.getElementById('new-desc');
    const amountInput = document.getElementById('new-amount');
    const typeInput = document.getElementById('new-type');
    const desc = descInput.value.trim(); const amount = parseFloat(amountInput.value); const type = typeInput.value;
    if(!desc) { alert('Please enter a description.'); return; }
    if(isNaN(amount) || amount <= 0) { alert('Please enter a positive amount.'); return; }
    budgetItems.push({ description: desc, amount, type }); saveBudget(); renderBudget();
    descInput.value=''; amountInput.value=''; typeInput.value='income';
  }
  function updateBudgetSummary() {
    const totalIncome = budgetItems.filter(i => i.type==='income').reduce((a,b)=>a+b.amount,0);
    const totalExpenses = budgetItems.filter(i => i.type==='expense').reduce((a,b)=>a+b.amount,0);
    const totalSavings = Math.max(totalIncome - totalExpenses, 0);
    const savingsPercent = totalIncome > 0 ? (totalSavings / totalIncome * 100) : 0;
    document.getElementById('total-income').textContent = totalIncome.toFixed(2);
    document.getElementById('total-expenses').textContent = totalExpenses.toFixed(2);
    document.getElementById('total-savings').textContent = totalSavings.toFixed(2);
    document.getElementById('savings-percent').textContent = savingsPercent.toFixed(1);
    const starMsgEl = document.getElementById('star-msg');
    if(savingsPercent >= 20 && totalIncome > 0) {
      starMsgEl.textContent = "🎉 Great job! You saved at least 20%. You earn 1 star! ⭐";
      if(!sessionStorage.getItem('savedStarForThisBudget')) {
        starCount++; saveStars(); sessionStorage.setItem('savedStarForThisBudget','true');
      }
    } else {
      starMsgEl.textContent = "Try to save at least 20% of your income to earn stars.";
      sessionStorage.removeItem('savedStarForThisBudget');
    }
  }
  renderBudget(); updateStarBadge();

  // ===== COIN SNAKE GAME =====
  (function(){
    const canvas = document.getElementById('board');
    const ctx = canvas.getContext('2d');
    const GRID = 20;      // 20x20 cells
    const CELL = canvas.width / GRID; // cell size in px (26 if 520px board)
    const speedBase = 130; // ms per tick (lower = faster)
    const growthColors = {1: getCSS('--coin1'), 2: getCSS('--coin2'), 5: getCSS('--coin5')};

    function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

    let snake, dir, nextDir, coin, score, growQueue, timer, running, highscore;
    let lastValueEaten = null;

    highscore = parseInt(localStorage.getItem('mm_coin_highscore')||'0')||0;
    qs('#highscore').textContent = highscore;

    function init() {
      snake = [{x:10,y:10, tint: growthColors[1]}];
      dir = {x:1,y:0}; nextDir = {x:1,y:0};
      score = 0; growQueue = []; lastValueEaten = null;
      placeCoin();
      updateHUD();
      draw();
    }

    function startPause() {
      if(running){ pause(); return; }
      running = true;
      loop();
      qs('#startBtn').textContent = 'Pause';
    }
    function pause() {
      running = false;
      if(timer) cancelAnimationFrame(timer);
      qs('#startBtn').textContent = 'Start';
    }
    function reset() {
      pause(); init(); draw(); qs('#startBtn').textContent = 'Start / Pause';
    }

    function loop(){
      let last = 0;
      const stepMs = () => Math.max(70, speedBase - Math.min(60, Math.floor(score/5)*5));
      const frame = (t) => {
        if(!running) return;
        if(t - last >= stepMs()){ last = t; tick(); draw(); }
        timer = requestAnimationFrame(frame);
      };
      timer = requestAnimationFrame(frame);
    }

    function tick(){
      // Set next direction chosen by input (no reverse)
      dir = nextDir;
      const head = {...snake[0]};
      head.x += dir.x; head.y += dir.y;

      // Wrap around edges
      if(head.x < 0) head.x = GRID-1;
      if(head.x >= GRID) head.x = 0;
      if(head.y < 0) head.y = GRID-1;
      if(head.y >= GRID) head.y = 0;

      // Detect self collision
      if(snake.some(s => s.x===head.x && s.y===head.y)){
        gameOver();
        return;
      }

      // Move snake
      snake.unshift({x: head.x, y: head.y, tint: snake[0].tint});

      // Check coin
      if(head.x === coin.x && head.y === coin.y){
        score += coin.value;
        lastValueEaten = coin.value;
        // enqueue growth color for as many segments as value
        for(let i=0;i<coin.value;i++) growQueue.push(growthColors[coin.value]);
        placeCoin();
      } else {
        // If growth queued, don't pop tail; instead tint current head from queue
        if(growQueue.length>0){
          snake[0].tint = growQueue.shift();
        } else {
          snake.pop();
        }
      }
      updateHUD();
    }

    function gameOver(){
      pause();
      if(score > highscore){
        highscore = score;
        localStorage.setItem('mm_coin_highscore', String(highscore));
        qs('#highscore').textContent = highscore;
      }
      // simple flash
      ctx.save();
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 28px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Game Over', canvas.width/2, canvas.height/2 - 10);
      ctx.font = '16px Inter, sans-serif';
      ctx.fillText('Press Start to play again', canvas.width/2, canvas.height/2 + 18);
      ctx.restore();
    }

    function placeCoin(){
      // Weighted values: R1 (60%), R2 (30%), R5 (10%)
      const r = Math.random();
      const value = r < 0.6 ? 1 : (r < 0.9 ? 2 : 5);
      let x, y;
      do {
        x = Math.floor(Math.random()*GRID);
        y = Math.floor(Math.random()*GRID);
      } while(snake.some(s=>s.x===x && s.y===y));
      coin = {x,y,value};
    }

    function draw(){
      // Clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Grid (subtle)
      ctx.strokeStyle = 'rgba(255,255,255,0.05)';
      ctx.lineWidth = 1;
      for(let i=0;i<=GRID;i++){
        const p = i*CELL;
        ctx.beginPath(); ctx.moveTo(p,0); ctx.lineTo(p,canvas.height); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,p); ctx.lineTo(canvas.width,p); ctx.stroke();
      }

      // Coin
      const cx = coin.x*CELL, cy = coin.y*CELL;
      ctx.fillStyle = coin.value===1?growthColors[1]:coin.value===2?growthColors[2]:growthColors[5];
      roundRect(ctx, cx+4, cy+4, CELL-8, CELL-8, 6, true);
      ctx.fillStyle = '#002b5c';
      ctx.font = 'bold '+Math.floor(CELL*0.6)+'px Inter, sans-serif';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText('R'+coin.value, cx + CELL/2, cy + CELL/2);

      // Snake
      for(let i=snake.length-1;i>=0;i--){
        const s = snake[i];
        const px = s.x*CELL, py = s.y*CELL;
        ctx.fillStyle = i===0 ? '#ffffff' : s.tint || '#cfe8ff';
        roundRect(ctx, px+3, py+3, CELL-6, CELL-6, 6, true);
        if(i===0){
          // eyes
          ctx.fillStyle = '#002b5c';
          const eyeOffsetX = dir.x!==0 ? 0 : 4;
          const eyeOffsetY = dir.y!==0 ? 0 : 4;
          ctx.beginPath(); ctx.arc(px+CELL/2 - eyeOffsetX, py+CELL/2 - eyeOffsetY, 2.5, 0, Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.arc(px+CELL/2 + eyeOffsetX, py+CELL/2 + eyeOffsetY, 2.5, 0, Math.PI*2); ctx.fill();
        }
      }

      // Last eaten badge
      if(lastValueEaten){
        ctx.fillStyle = 'rgba(0,0,0,0.35)';
        roundRect(ctx, 10, 10, 90, 28, 8, true);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 14px Inter, sans-serif'; ctx.textAlign = 'left'; ctx.textBaseline = 'middle';
        ctx.fillText('Last: R'+lastValueEaten, 18, 24);
      }
    }

    function updateHUD(){
      qs('#score').textContent = score;
      qs('#length').textContent = snake.length;
    }

    // Helpers
    function qs(sel){ return document.querySelector(sel); }
    function roundRect(ctx, x, y, w, h, r, fill){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      if(fill) ctx.fill(); else ctx.stroke();
    }

    // Input
    function setDir(nx, ny){
      // prevent reversing directly into self
      if(nx === -dir.x && ny === -dir.y) return;
      nextDir = {x:nx, y:ny};
    }
    window.addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      if(['arrowup','w'].includes(k)) setDir(0,-1);
      else if(['arrowdown','s'].includes(k)) setDir(0,1);
      else if(['arrowleft','a'].includes(k)) setDir(-1,0);
      else if(['arrowright','d'].includes(k)) setDir(1,0);
      else if(k===' '){ startPause(); }
    });

    // Mobile buttons
    qs('#btnUp').addEventListener('click', ()=>setDir(0,-1));
    qs('#btnDown').addEventListener('click', ()=>setDir(0,1));
    qs('#btnLeft').addEventListener('click', ()=>setDir(-1,0));
    qs('#btnRight').addEventListener('click', ()=>setDir(1,0));

    // Buttons
    qs('#startBtn').addEventListener('click', startPause);
    qs('#resetBtn').addEventListener('click', reset);

    // Boot
    init();
  })();
</script>
</body>
</html>
